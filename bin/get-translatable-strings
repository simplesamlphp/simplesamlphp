#!/usr/bin/php -q
<?php

declare(strict_types=1);

use SimpleSAML\Module;
use SimpleSAML\Utils;
use Symfony\Component\Filesystem\Filesystem;

// This is the base directory of the SimpleSAMLphp installation
$baseDir = dirname(dirname(__FILE__));

// Add library autoloader
require_once($baseDir . '/lib/_autoload.php');

$transUtils = new Utils\Translate();
$sysUtils = new Utils\System();
$filesystem = new Filesystem();

$tempDirBase = $sysUtils->getTempDir() . "/temptemplatestemp";
// Ensure no leftover from any previous invocation
$filesystem->remove($tempDirBase);

$outputSuffix = '/locales/en/LC_MESSAGES';

$modules = ['', 'core', 'admin', 'cron', 'exampleauth', 'multiauth', 'saml'];

foreach($modules as $module) {
    $tempDir = $tempDirBase . "/" . $module;
    $transUtils->compileAllTemplates($module, $tempDir);
    $domain = $module ?: 'messages';

    $outputDir = $baseDir . ($module === '' ? '' : '/modules/' . $module) . $outputSuffix;
    print `xgettext --default-domain=$domain -p $outputDir --from-code=UTF-8 -j --no-location -ktrans -L PHP $tempDir/*/*.php`;
}

$filesystem->remove($tempDirBase);
// TODO: merge new strings into translated languages catalogs
